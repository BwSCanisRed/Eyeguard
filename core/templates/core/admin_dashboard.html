<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Administrativo - EyeGuard</title>
    <style>
        :root{
            --bg:#071026;
            --panel:#07172a;
            --muted:#9aa4b2;
            --accent-green:#27ae60;
            --accent-magenta:#7b2cbf;
            --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            --radius:12px;
            --glass: rgba(255,255,255,0.03);
            --input-bg: rgba(255,255,255,0.04);
            --error: #ff4d6d;
            --error-bg: rgba(255,77,109,0.1);
        }
        html,body{height:100%;margin:0}
        body{
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: linear-gradient(180deg,#071026 0%, #0b1220 60%);
            color:#fff;
            padding:20px;
        }
        .form-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }
        .section-card {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section-card h3 {
            color: var(--accent-green);
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        label {
            display: block;
            color: var(--muted);
            font-size: 0.9rem;
            margin-bottom: 6px;
        }
        input, select {
            width: 100%;
            padding: 10px 12px;
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            color: #fff;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-magenta);
            box-shadow: 0 0 0 2px rgba(123,44,191,0.2);
        }
        select {
            cursor: pointer;
            background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
                            linear-gradient(135deg, var(--muted) 50%, transparent 50%);
            background-position: calc(100% - 20px) calc(1em + 2px),
                               calc(100% - 15px) calc(1em + 2px);
            background-size: 5px 5px,
                           5px 5px;
            background-repeat: no-repeat;
            padding-right: 30px;
        }
        select option {
            background-color: var(--bg);
            color: #fff;
        }
        .form-error {
            color: var(--error);
            font-size: 0.85rem;
            margin-top: 4px;
        }
        .form-error-box {
            background: var(--error-bg);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .header{
            display:flex;align-items:center;justify-content:space-between;padding:18px 26px;background:transparent;border-radius:12px;margin-bottom:18px
        }
        .brand{display:flex;align-items:center;gap:12px}
        .brand .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent-green),var(--accent-magenta));display:flex;align-items:center;justify-content:center;font-weight:700}
        .container{max-width:1200px;margin:0 auto;padding:0 12px}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
        .card{background:var(--card-bg);border-radius:var(--radius);padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
        .form-group{margin-bottom:12px}
        label{display:block;margin-bottom:6px;color:var(--muted);font-weight:600}
        input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
    /* Selects: show a subtle light background so options are readable on open; option colors set for better contrast */
        select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.95);color:#0b1220;appearance:none;-moz-appearance:none;-webkit-appearance:none}
        select:focus{outline:2px solid rgba(123,44,191,0.18)}
        select option{color:#0b1220;background:#fff}
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin: 6px 4px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-magenta));
            color: #fff;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39,174,96,0.2);
        }
        .btn-success {
            background: var(--accent-green);
            color: #fff;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-danger {
            background: var(--error);
            color: #fff;
        }
        .btn-danger:hover {
            background: #ff3355;
        }
        .messages{list-style:none;padding:0;margin:1rem 0}
        .messages li{padding:10px;margin-bottom:10px;border-radius:8px}
        .messages .success{background:rgba(39,174,96,0.12);color:var(--accent-green)}
        .messages .error{background:rgba(255,77,109,0.08);color:#ffb3be}
        .card h2{margin-top:0;color:#fff;padding-bottom:10px;margin-bottom:14px}
        .tabs{display:flex;margin-bottom:18px}
        .tab{padding:8px 12px;cursor:pointer;border:none;background:transparent;color:var(--muted);margin-right:6px;border-radius:8px}
        .tab.active{background:linear-gradient(90deg,var(--accent-green),var(--accent-magenta));color:#fff}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .conductor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            padding: 16px;
        }
        .conductor-card {
            background: var(--glass);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .conductor-card.streaming {
            border: 2px solid var(--accent-green);
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
        }
        .streaming-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--accent-green);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .streaming-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .conductor-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }
        .estado-fatiga {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .estado-normal {
            background: var(--accent-green);
        }
        .estado-precaucion {
            background: #df862e;
        }
        .estado-peligro {
            background: #ff4d6d;
        }
        .vehiculo-info{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.03)}
        .conductor-info-minimal {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .conductor-info-minimal h4 {
            margin: 0 0 12px 0;
            color: var(--accent-green);
            font-size: 1.1rem;
        }
        .phone-link {
            color: var(--accent-magenta);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        .phone-link:hover {
            color: var(--accent-green);
        }
        .phone-icon {
            font-style: normal;
        }
        .placa {
            background: rgba(255,255,255,0.04);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 8px 0;
        }
        .score-display {
            margin: 12px 0;
            text-align: center;
        }
        .btn-sm {
            font-size: 0.875rem;
            padding: 8px 16px;
            border-radius: 6px;
            width: 100%;
        }
        .mt-2 {
            margin-top: 0.5rem;
        }
        .stream-wrapper {
            width: 100%;
        }
        .stream-container {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stream-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .info-wrapper {
            width: 100%;
        }
        .conductor-info-card {
            background: #1d1d1d;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .conductor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .conductor-header h4 {
            margin: 0;
            color: var(--accent-green);
            font-size: 1.1rem;
            font-weight: 600;
        }
        .conductor-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .phone-link {
            color: var(--accent-magenta);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        .phone-link:hover {
            color: var(--accent-green);
        }
        .placa-badge {
            background: rgba(39,174,96,0.1);
            color: var(--accent-green);
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container" style="display:flex;justify-content:space-between;align-items:center">
            <div class="brand">
                <div class="logo">EG</div>
                <div>
                    <h1 style="margin:0;font-size:1.1rem">EyeGuard - Dashboard</h1>
                </div>
            </div>
            <div>
                <form method="post" action="{% url 'logout' %}" style="display:inline-block;margin:0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff;padding:8px 12px;border-radius:8px">Cerrar sesi칩n</button>
                </form>
            </div>
        </div>
    </div>

    <div class="container">
        {% if messages %}
        <ul class="messages">
            {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'registroTab')">Registrar Conductor</button>
            <button class="tab" onclick="openTab(event, 'monitoreoTab')">Monitorear Conductores</button>
        </div>

        <div id="registroTab" class="tab-content active">
            <div class="card">
                <div class="conductor-selector">
                    <h2>{% if conductor_seleccionado %}Editar Conductor{% else %}Registrar Nuevo Conductor{% endif %}</h2>
                    
                    <div class="form-group mb-4">
                        <label for="conductor_select">Seleccionar Conductor Existente:</label>
                        <select id="conductor_select" class="form-control" onchange="seleccionarConductor(this.value)">
                            <option value="">-- Nuevo Conductor --</option>
                            {% for c in conductores %}
                                <option value="{{ c.id }}" {% if conductor_seleccionado.id == c.id %}selected{% endif %}>
                                    {{ c.nombre_completo }} - {{ c.documento }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <form method="POST">
                    {% csrf_token %}
                    {# show non-field errors for the conductor form #}
                    {% if conductor_form.non_field_errors %}
                        <div style="color:#ffb3be;margin-bottom:10px">
                            {{ conductor_form.non_field_errors }}
                        </div>
                    {% endif %}
                    {% if conductor_seleccionado %}
                        <input type="hidden" name="editar_conductor" value="1">
                    {% endif %}

                    <div class="form-columns">
                        <div class="form-column">
                            {% if not conductor_seleccionado %}
                            <div class="section-card">
                                <h3>Datos de Usuario</h3>
                                <div class="form-group">
                                    <label for="id_username">Nombre de usuario:</label>
                                    {{ conductor_form.username }}
                                    {% if conductor_form.username.errors %}
                                        <div class="form-error">{{ conductor_form.username.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="id_password">Contrase침a:</label>
                                    {{ conductor_form.password }}
                                    {% if conductor_form.password.errors %}
                                        <div class="form-error">{{ conductor_form.password.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="section-card">
                                <h3>Datos del Conductor</h3>
                                <div class="form-group">
                                    <label for="id_email">Correo electr칩nico:</label>
                                    {{ conductor_form.email }}
                                    {% if conductor_form.email.errors %}
                                        <div class="form-error">{{ conductor_form.email.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="id_nombres">Nombres:</label>
                                    {{ conductor_form.nombres }}
                                    {% if conductor_form.nombres.errors %}
                                        <div class="form-error">{{ conductor_form.nombres.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="id_apellidos">Apellidos:</label>
                                    {{ conductor_form.apellidos }}
                                    {% if conductor_form.apellidos.errors %}
                                        <div class="form-error">{{ conductor_form.apellidos.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="id_documento">Documento:</label>
                                        {{ conductor_form.documento }}
                                        {% if conductor_form.documento.errors %}
                                            <div class="form-error">{{ conductor_form.documento.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="id_telefono">Tel칠fono:</label>
                                        {{ conductor_form.telefono }}
                                        {% if conductor_form.telefono.errors %}
                                            <div class="form-error">{{ conductor_form.telefono.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="id_licencia">Licencia:</label>
                                        {{ conductor_form.licencia }}
                                    </div>
                                    <div class="form-group">
                                        <label for="id_licencia_vencimiento">Vencimiento:</label>
                                        {{ conductor_form.licencia_vencimiento }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-column">
                            <div class="section-card">
                                <h3>Datos del Veh칤culo</h3>
                                {% if vehiculo_form.non_field_errors %}
                                    <div class="form-error form-error-box">{{ vehiculo_form.non_field_errors }}</div>
                                {% endif %}
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="id_placa">Placa:</label>
                                        {{ vehiculo_form.placa }}
                                        {% if vehiculo_form.placa.errors %}
                                            <div class="form-error">{{ vehiculo_form.placa.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="id_marca">Marca:</label>
                                        {{ vehiculo_form.marca }}
                                        {% if vehiculo_form.marca.errors %}
                                            <div class="form-error">{{ vehiculo_form.marca.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="id_modelo">Modelo:</label>
                                        {{ vehiculo_form.modelo }}
                                        {% if vehiculo_form.modelo.errors %}
                                            <div class="form-error">{{ vehiculo_form.modelo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="id_color">Color:</label>
                                        {{ vehiculo_form.color }}
                                        {% if vehiculo_form.color.errors %}
                                            <div class="form-error">{{ vehiculo_form.color.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="id_tipo_carroceria">Tipo de Carrocer칤a:</label>
                                        {{ vehiculo_form.tipo_carroceria }}
                                        {% if vehiculo_form.tipo_carroceria.errors %}
                                            <div class="form-error">{{ vehiculo_form.tipo_carroceria.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="id_servicio">Servicio:</label>
                                        {{ vehiculo_form.servicio }}
                                        {% if vehiculo_form.servicio.errors %}
                                            <div class="form-error">{{ vehiculo_form.servicio.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if conductor_seleccionado %}
                        <button type="submit" class="btn btn-primary">Actualizar Conductor y Veh칤culo</button>
                        <button type="button" class="btn" onclick="seleccionarConductor('')">Cancelar edici칩n</button>
                    {% else %}
                        <button type="submit" class="btn btn-primary">Registrar Conductor y Veh칤culo</button>
                    {% endif %}
                </form>
            </div>
        </div>

        <div id="monitoreoTab" class="tab-content">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                    <h2 style="margin:0">Monitoreo de Conductores</h2>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <button type="button" class="btn btn-success" onclick="refrescarMonitoreo()">Refrescar estado</button>
                        <form id="exportForm" method="get" action="{% url 'export_critical_events' %}" style="display:flex;gap:8px;align-items:center;">
                        <input type="date" name="from" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff" />
                        <input type="date" name="to" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff" />
                        <button class="btn btn-primary" type="submit">Descargar Informe CSV</button>
                        </form>
                    </div>
                </div>
                <div class="conductor-grid">
                    {% for conductor in conductores %}
                    <div class="conductor-card {% if conductor.autenticado %}streaming{% endif %}" id="conductor-card-{{ conductor.id }}" data-conductor-id="{{ conductor.id }}">
                        {% if conductor.autenticado %}
                        <div class="streaming-badge">
                            <span class="streaming-dot"></span>
                            EN VIVO
                        </div>
                        {% endif %}
                        <div class="conductor-content">
                            <div class="stream-wrapper">
                                <div class="stream-container">
                                    <img src="{% url 'stream_mjpeg' conductor.id %}" alt="Stream {{ conductor.usuario.username }}" class="stream-video" />
                                </div>
                            </div>
                            <div class="info-wrapper">
                                <div class="conductor-info-card">
                                    <div class="conductor-header">
                                        <h4>{{ conductor.nombre_completo }}</h4>
                                        <span id="score-{{ conductor.id }}" data-url="{% url 'stream_score' conductor.id %}" class="estado-fatiga estado-normal">Cargando...</span>
                                    </div>
                                    
                                    <div class="conductor-details">
                                        <a href="tel:{{ conductor.telefono }}" class="phone-link">
                                            <i class="phone-icon">游</i> {{ conductor.telefono }}
                                        </a>
                                        {% if conductor.vehiculos.first %}
                                            <div class="placa-badge">{{ conductor.vehiculos.first.placa }}</div>
                                        {% endif %}
                                    </div>

                                    <form method="post" action="{% url 'delete_conductor' conductor.id %}" onsubmit="return confirm('쮼liminar conductor {{ conductor.nombre_completo }}? Esta acci칩n es irreversible.');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p>No hay conductores registrados.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function seleccionarConductor(conductorId) {
            if (conductorId) {
                window.location.href = '?conductor_id=' + conductorId;
            } else {
                window.location.href = window.location.pathname;
            }
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            
            // Ocultar todos los contenidos de las pesta침as
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Remover la clase "active" de todas las pesta침as
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Mostrar la pesta침a actual y marcarla como activa
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Polling para actualizar scores en vivo
        function actualizarScores() {
            const scoreSpans = document.querySelectorAll('[id^="score-"]');
            const promises = [];
            scoreSpans.forEach(span => {
                const url = span.dataset.url;
                if (!url) return;
                const promise = fetch(url)
                    .then(resp => resp.json())
                    .then(data => {
                        const s = parseInt(data.score, 10);
                        span.textContent = s;
                        span.classList.remove('estado-normal','estado-precaucion','estado-peligro');
                        if (s >= 70) {
                            span.classList.add('estado-normal');
                        } else if (s >= 30) {
                            span.classList.add('estado-precaucion');
                        } else {
                            span.classList.add('estado-peligro');
                        }
                    }).catch(err => {
                        // no hacer nada por ahora
                    });
                promises.push(promise);
            });
            return Promise.all(promises);
        }

        // Actualizar estado de streaming de conductores
        function actualizarEstadoStreaming() {
            return fetch('/api/conductores_activos/')
                .then(resp => resp.json())
                .then(data => {
                    const conductoresActivos = data.conductores_activos || [];
                    
                    // Actualizar todas las tarjetas de conductores
                    document.querySelectorAll('.conductor-card').forEach(card => {
                        const conductorId = card.dataset.conductorId;
                        const isStreaming = conductoresActivos.includes(conductorId);
                        
                        // Agregar/remover clase streaming
                        if (isStreaming) {
                            if (!card.classList.contains('streaming')) {
                                card.classList.add('streaming');
                                // Agregar badge si no existe
                                if (!card.querySelector('.streaming-badge')) {
                                    const badge = document.createElement('div');
                                    badge.className = 'streaming-badge';
                                    badge.innerHTML = '<span class="streaming-dot"></span>EN VIVO';
                                    card.insertBefore(badge, card.firstChild);
                                }
                            }
                        } else {
                            card.classList.remove('streaming');
                            // Remover badge si existe
                            const badge = card.querySelector('.streaming-badge');
                            if (badge) {
                                badge.remove();
                            }
                        }
                    });
                }).catch(err => {
                    console.error('Error al actualizar estado de streaming:', err);
                });
        }

        // iniciar polling cada 2s cuando se abra la pesta침a de monitoreo
        setInterval(function(){
            // solo actualizar si la pesta침a monitoreo est치 visible
            const monitoreo = document.getElementById('monitoreoTab');
            if (monitoreo && monitoreo.style.display !== 'none') {
                actualizarScores();
                actualizarEstadoStreaming();
            }
        }, 2000);

        // Bot칩n de refresco manual con feedback visual
        function refrescarMonitoreo(){
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Actualizando...';
            btn.style.opacity = '0.6';
            
            // Ejecutar actualizaci칩n
            Promise.all([
                actualizarScores(),
                actualizarEstadoStreaming()
            ]).finally(() => {
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    btn.style.opacity = '1';
                }, 500);
            });
        }
    </script>
</body>
</html>
