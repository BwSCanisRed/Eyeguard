<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Conductor - EyeGuard</title>
    <style>
        :root {
            --bg: #071026;
            --panel: #07172a;
            --muted: #9aa4b2;
            --accent-green: #27ae60;
            --accent-magenta: #7b2cbf;
            --white: #ffffff;
            --glass: rgba(255,255,255,0.03);
        }
        
        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #071026 0%, #0b1220 60%);
            color: var(--white);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--glass);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-magenta));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: var(--glass);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .card h2 {
            margin-top: 0;
            color: var(--accent-green);
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .info-item {
            background: rgba(255,255,255,0.02);
            padding: 15px;
            border-radius: 8px;
        }

        .info-item h3 {
            color: var(--accent-magenta);
            margin-top: 0;
            font-size: 1.1rem;
        }

        .info-item p {
            margin: 5px 0;
            color: var(--muted);
        }

        .info-item strong {
            color: var(--white);
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-magenta));
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.success {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid var(--accent-green);
        }

        .alert.warning {
            background: rgba(255, 159, 67, 0.1);
            border: 1px solid #ff9f43;
        }
        #fatigueRiskAlert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(231,76,60,0.15);
            border: 1px solid #e74c3c;
            padding: 16px 20px;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            backdrop-filter: blur(6px);
            box-shadow: 0 4px 24px -4px rgba(231,76,60,0.4);
            display: none;
            z-index: 1000;
            animation: pulse 1.1s infinite;
        }
        #fatigueRiskAlert span { display:block; font-size:0.85rem; font-weight:400; margin-top:4px; color:#ffb3a7; }
        @keyframes pulse {
            0% { box-shadow:0 0 0 0 rgba(231,76,60,0.7); }
            70% { box-shadow:0 0 0 14px rgba(231,76,60,0); }
            100% { box-shadow:0 0 0 0 rgba(231,76,60,0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand">
                <div class="logo">EG</div>
                <div>
                    <h1 style="margin:0;font-size:1.2rem">EyeGuard - Panel de Conductor</h1>
                </div>
            </div>
            <form method="post" action="{% url 'logout' %}" style="display:inline-block">
                {% csrf_token %}
                <button type="submit" class="btn">Cerrar sesión</button>
            </form>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="card">
            <h2>Información Personal</h2>
            <div class="info-grid">
                <div class="info-item">
                    <h3>Datos del Conductor</h3>
                    <p><strong>Nombre completo:</strong> {{ request.user.perfil_conductor.nombre_completo }}</p>
                    <p><strong>Documento:</strong> {{ request.user.perfil_conductor.documento }}</p>
                    <p><strong>Correo:</strong> {{ request.user.email }}</p>
                    <p><strong>Teléfono:</strong> {{ request.user.perfil_conductor.telefono }}</p>
                </div>
                <div class="info-item">
                    <h3>Licencia de Conducción</h3>
                    <p><strong>Categoría:</strong> {{ request.user.perfil_conductor.licencia }}</p>
                    {% if request.user.perfil_conductor.licencia_vencimiento %}
                    <p><strong>Fecha de vencimiento:</strong> {{ request.user.perfil_conductor.licencia_vencimiento }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Vehículo Asignado</h2>
            <div class="info-grid">
                {% with vehiculo=request.user.perfil_conductor.vehiculos.first %}
                {% if vehiculo %}
                <div class="info-item">
                    <h3>Datos del Vehículo</h3>
                    <p><strong>Placa:</strong> {{ vehiculo.placa }}</p>
                    <p><strong>Marca:</strong> {{ vehiculo.marca }}</p>
                    <p><strong>Modelo:</strong> {{ vehiculo.modelo }}</p>
                    <p><strong>Color:</strong> {{ vehiculo.color }}</p>
                </div>
                <div class="info-item">
                    <h3>Información Adicional</h3>
                    <p><strong>Tipo de Carrocería:</strong> {{ vehiculo.tipo_carroceria }}</p>
                    <p><strong>Servicio:</strong> {{ vehiculo.get_servicio_display }}</p>
                </div>
                {% else %}
                <div class="info-item">
                    <p>No hay vehículo asignado actualmente.</p>
                </div>
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <div class="card">
            <h2>Estado Actual</h2>
            <div class="info-grid">
                <div class="info-item">
                    <h3>Monitor de Fatiga</h3>
                    <p><strong>Estado:</strong> 
                        {% if request.user.perfil_conductor.estado_fatiga < 0.3 %}
                            <span style="color: var(--accent-green)">Normal</span>
                        {% elif request.user.perfil_conductor.estado_fatiga < 0.7 %}
                            <span style="color: #ff9f43">Precaución</span>
                        {% else %}
                            <span style="color: #ff4757">Alerta</span>
                        {% endif %}
                    </p>
                    <p><strong>Última actualización:</strong> {% now "j/n/Y H:i" %}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Monitoreo de Somnolencia</h2>
            <div style="text-align: center;">
                <button id="toggleCameraBtn" class="btn" style="margin-bottom: 20px; cursor: pointer;">
                    Activar Cámara
                </button>
                <div id="cameraStatus" style="margin-bottom: 15px; color: var(--muted);">
                    Cámara desactivada
                </div>
                <video id="videoElement" autoplay playsinline style="width: 100%; max-width: 640px; border-radius: 8px; display: none; background: black;"></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div id="fatigueScore" style="margin-top: 15px; font-size: 1.2rem; display: none;">
                    <strong>Índice de Fatiga:</strong> <span id="scoreValue" style="color: var(--accent-green);">0</span>
                </div>
                <div id="fatigueRiskAlert">
                    ⚠️ ALERTA DE SOMNOLENCIA
                    <span>Índice por debajo de 50. Por favor mantente alerta.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const toggleBtn = document.getElementById('toggleCameraBtn');
        const statusDiv = document.getElementById('cameraStatus');
        const fatigueScoreDiv = document.getElementById('fatigueScore');
        const scoreValue = document.getElementById('scoreValue');
    const fatigueRiskAlert = document.getElementById('fatigueRiskAlert');
        
        let stream = null;
        let isStreaming = false;
        let sendInterval = null;
        let uploading = false;
        let targetInterval = 200;
        let frameTimeout = null;

        toggleBtn.addEventListener('click', async () => {
            if (!isStreaming) {
                await startCamera();
            } else {
                stopCamera();
            }
        });

        async function startCamera() {
            try {
                // Detectar iOS/Safari para ajustar constraints
                const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 360 },
                        frameRate: isiOS ? { ideal: 12, max: 15 } : { ideal: 15, max: 20 },
                        facingMode: 'user'
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Atributos críticos para iOS Safari
                video.setAttribute('playsinline', 'true');
                video.setAttribute('autoplay', 'true');
                video.setAttribute('muted', 'true');
                video.muted = true;
                video.autoplay = true;
                
                video.style.display = 'block';
                isStreaming = true;
                toggleBtn.textContent = 'Desactivar Cámara';
                toggleBtn.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                statusDiv.textContent = 'Cámara activa - Transmitiendo...';
                statusDiv.style.color = 'var(--accent-green)';
                fatigueScoreDiv.style.display = 'block';

                // Esperar a que el video esté listo
                video.onloadedmetadata = () => {
                    // Normalizar resolución para reducir ancho de banda
                    const targetW = 640;
                    const aspect = video.videoHeight / video.videoWidth || (9/16);
                    const targetH = Math.round(targetW * aspect);
                    canvas.width = targetW;
                    canvas.height = targetH;
                    ctx.imageSmoothingEnabled = true;
                    
                    // Scheduler adaptativo para iOS (evita solapamiento)
                    targetInterval = isiOS ? 250 : 200;
                    scheduleNext();
                };

            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                statusDiv.textContent = 'Error: No se pudo acceder a la cámara';
                statusDiv.style.color = '#e74c3c';
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
                stream = null;
            }
            
            if (sendInterval) {
                clearInterval(sendInterval);
                sendInterval = null;
            }
            if (frameTimeout) {
                clearTimeout(frameTimeout);
                frameTimeout = null;
            }
            
            isStreaming = false;
            uploading = false;
            toggleBtn.textContent = 'Activar Cámara';
            toggleBtn.style.background = 'linear-gradient(90deg, var(--accent-green), var(--accent-magenta))';
            statusDiv.textContent = 'Cámara desactivada';
            statusDiv.style.color = 'var(--muted)';
            fatigueScoreDiv.style.display = 'none';

            // Notificar al servidor que se detuvo la transmisión
            fetch('/conductor/stop_stream/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
        }

        function scheduleNext() {
            if (frameTimeout) clearTimeout(frameTimeout);
            frameTimeout = setTimeout(sendFrame, targetInterval);
        }

        async function sendFrame() {
            // Back-pressure: no enviar si el anterior no terminó
            if (!isStreaming || video.paused || video.ended || uploading) {
                if (isStreaming) scheduleNext();
                return;
            }
            
            uploading = true;
            const t0 = performance.now();
            
            // Dibujar frame reescalado al canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Ajustar calidad JPEG según plataforma
            const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const quality = isiOS ? 0.5 : 0.6;
            
            canvas.toBlob(async (blob) => {
                try {
                    if (!blob) {
                        uploading = false;
                        scheduleNext();
                        return;
                    }

                    const formData = new FormData();
                    formData.append('frame', blob, 'frame.jpg');
                    
                    const response = await fetch('/conductor/send_frame/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData,
                        cache: 'no-store'
                    });

                    const data = await response.json();
                    if (data && typeof data.score === 'number') {
                        scoreValue.textContent = data.score;
                        
                        // Cambiar color según el nivel de fatiga
                        if (data.score < 30) {
                            scoreValue.style.color = 'var(--accent-green)';
                        } else if (data.score < 70) {
                            scoreValue.style.color = '#ff9f43';
                        } else {
                            scoreValue.style.color = '#e74c3c';
                        }

                        // Mostrar alerta visual si score < 50
                        if (data.score < 50) {
                            fatigueRiskAlert.style.display = 'block';
                        } else {
                            fatigueRiskAlert.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error al enviar frame:', error);
                } finally {
                    const dt = performance.now() - t0;
                    // Adaptar intervalo dinámicamente según latencia de red
                    const adaptiveInterval = Math.min(500, Math.max(150, Math.round(dt * 1.3)));
                    targetInterval = adaptiveInterval;
                    uploading = false;
                    scheduleNext();
                }
            }, 'image/jpeg', quality);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Detener la cámara cuando se cierre la página
        window.addEventListener('beforeunload', () => {
            if (isStreaming) {
                stopCamera();
            }
        });
    </script>
</body>
</html>
