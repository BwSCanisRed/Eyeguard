{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <title>{% trans "Panel de Conductor" %} - EyeGuard</title>
    <style>
        :root {
            --bg: #071026;
            --panel: #07172a;
            --muted: #9aa4b2;
            --accent-green: #27ae60;
            --accent-magenta: #7b2cbf;
            --white: #ffffff;
            --glass: rgba(255,255,255,0.03);
        }
        
        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #071026 0%, #0b1220 60%);
            color: var(--white);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--glass);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-magenta));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: var(--glass);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .card h2 {
            margin-top: 0;
            color: var(--accent-green);
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .info-item {
            background: rgba(255,255,255,0.02);
            padding: 15px;
            border-radius: 8px;
        }

        .info-item h3 {
            color: var(--accent-magenta);
            margin-top: 0;
            font-size: 1.1rem;
        }

        .info-item p {
            margin: 5px 0;
            color: var(--muted);
        }

        .info-item strong {
            color: var(--white);
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-magenta));
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.success {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid var(--accent-green);
        }

        .alert.warning {
            background: rgba(255, 159, 67, 0.1);
            border: 1px solid #ff9f43;
        }
        #fatigueRiskAlert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231,76,60,0.2);
            border: 2px solid #e74c3c;
            padding: 24px 28px;
            border-radius: 16px;
            color: #fff;
            font-weight: 700;
            font-size: 1.25rem;
            text-align: center;
            line-height: 1.25;
            backdrop-filter: blur(8px);
            box-shadow: 0 12px 36px -8px rgba(231,76,60,0.6);
            display: none;
            z-index: 2000;
            animation: pulse 1.1s infinite;
            max-width: 90vw;
            min-width: 320px;
        }
        #fatigueRiskAlert span { display:block; font-size:1rem; font-weight:500; margin-top:6px; color:#ffd5cf; }
        @keyframes pulse {
            0% { box-shadow:0 0 0 0 rgba(231,76,60,0.7); }
            70% { box-shadow:0 0 0 14px rgba(231,76,60,0); }
            100% { box-shadow:0 0 0 0 rgba(231,76,60,0); }
        }
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            background: var(--glass);
            padding: 8px 12px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 999;
        }
        .language-selector button {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            padding: 6px 12px;
            border-radius: 8px;
            color: var(--muted);
        }
        .language-selector button:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.08);
            color: var(--white);
        }
        .language-selector button.active {
            background: var(--accent-green);
            color: var(--white);
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <button onclick="changeLanguage('en')" title="English" id="lang-en">EN</button>
        <button onclick="changeLanguage('es')" title="Espa침ol" id="lang-es" class="active">ES</button>
        <button onclick="changeLanguage('de')" title="Deutsch" id="lang-de">DE</button>
        <button onclick="changeLanguage('fr')" title="Fran칞ais" id="lang-fr">FR</button>
        <button onclick="changeLanguage('pt')" title="Portugu칡s" id="lang-pt">PT</button>
    </div>
    <div class="container">
        <div class="header">
            <div class="brand">
                <div class="logo">EG</div>
                <div>
                    <h1 style="margin:0;font-size:1.2rem">EyeGuard - {% trans "Panel de Conductor" %}</h1>
                </div>
            </div>
            <form method="post" action="{% url 'logout' %}" style="display:inline-block">
                {% csrf_token %}
                <button type="submit" class="btn">{% trans "Cerrar sesi칩n" %}</button>
            </form>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="card">
            <h2>{% trans "Informaci칩n Personal" %}</h2>
            <div class="info-grid">
                <div class="info-item">
                    <h3>{% trans "Datos del Conductor" %}</h3>
                    <p><strong>{% trans "Nombre completo" %}:</strong> {{ request.user.perfil_conductor.nombre_completo }}</p>
                    <p><strong>{% trans "Documento" %}:</strong> {{ request.user.perfil_conductor.documento }}</p>
                    <p><strong>{% trans "Correo" %}:</strong> {{ request.user.email }}</p>
                    <p><strong>{% trans "Tel칠fono" %}:</strong> {{ request.user.perfil_conductor.telefono }}</p>
                </div>
                <div class="info-item">
                    <h3>{% trans "Licencia de Conducci칩n" %}</h3>
                    <p><strong>{% trans "Categor칤a" %}:</strong> {{ request.user.perfil_conductor.licencia }}</p>
                    {% if request.user.perfil_conductor.licencia_vencimiento %}
                    <p><strong>{% trans "Fecha de vencimiento" %}:</strong> {{ request.user.perfil_conductor.licencia_vencimiento }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card">
            <h2>{% trans "Veh칤culo Asignado" %}</h2>
            <div class="info-grid">
                {% with vehiculo=request.user.perfil_conductor.vehiculos.first %}
                {% if vehiculo %}
                <div class="info-item">
                    <h3>{% trans "Datos del Veh칤culo" %}</h3>
                    <p><strong>{% trans "Placa" %}:</strong> {{ vehiculo.placa }}</p>
                    <p><strong>{% trans "Marca" %}:</strong> {{ vehiculo.marca }}</p>
                    <p><strong>{% trans "Modelo" %}:</strong> {{ vehiculo.modelo }}</p>
                    <p><strong>{% trans "Color" %}:</strong> {{ vehiculo.color }}</p>
                </div>
                <div class="info-item">
                    <h3>{% trans "Informaci칩n Adicional" %}</h3>
                    <p><strong>{% trans "Tipo de Carrocer칤a" %}:</strong> {{ vehiculo.tipo_carroceria }}</p>
                    <p><strong>{% trans "Servicio" %}:</strong> {{ vehiculo.get_servicio_display }}</p>
                </div>
                {% else %}
                <div class="info-item">
                    <p>{% trans "No hay veh칤culo asignado actualmente." %}</p>
                </div>
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <div class="card">
            <h2>{% trans "Estado Actual" %}</h2>
            <div class="info-grid">
                <div class="info-item">
                    <h3>{% trans "Monitor de Fatiga" %}</h3>
                    <p><strong>{% trans "Estado" %}:</strong> 
                        {% if request.user.perfil_conductor.estado_fatiga < 0.3 %}
                            <span style="color: var(--accent-green)">{% trans "Normal" %}</span>
                        {% elif request.user.perfil_conductor.estado_fatiga < 0.7 %}
                            <span style="color: #ff9f43">{% trans "Precauci칩n" %}</span>
                        {% else %}
                            <span style="color: #ff4757">{% trans "Alerta" %}</span>
                        {% endif %}
                    </p>
                    <p><strong>{% trans "칔ltima actualizaci칩n" %}:</strong> {% now "j/n/Y H:i" %}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>{% trans "Monitoreo de Somnolencia" %}</h2>
            <div style="text-align: center;">
                <button id="toggleCameraBtn" class="btn" style="margin-bottom: 20px; cursor: pointer;">
                    {% trans "Activar C치mara" %}
                </button>
                <div id="cameraStatus" style="margin-bottom: 15px; color: var(--muted);">
                    {% trans "C치mara desactivada" %}
                </div>
                <video id="videoElement" autoplay playsinline style="width: 100%; max-width: 640px; border-radius: 8px; display: none; background: black;"></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div id="locationInfo" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; display: none;">
                    <strong>游늸 Ubicaci칩n:</strong> <span id="locationText" style="color: var(--muted);">Obteniendo ubicaci칩n...</span>
                </div>
                <div id="fatigueScore" style="margin-top: 15px; font-size: 1.2rem; display: none;">
                    <strong>{% trans "칈ndice de Fatiga" %}:</strong> <span id="scoreValue" style="color: var(--accent-green);">0</span>
                </div>
                <div id="fatigueRiskAlert">
                    丘멆잺 {% trans "ALERTA DE SOMNOLENCIA" %}
                    <span>{% trans "칈ndice por debajo de 50. Por favor mantente alerta." %}</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const toggleBtn = document.getElementById('toggleCameraBtn');
        const statusDiv = document.getElementById('cameraStatus');
        const fatigueScoreDiv = document.getElementById('fatigueScore');
        const scoreValue = document.getElementById('scoreValue');
        const fatigueRiskAlert = document.getElementById('fatigueRiskAlert');
        const locationInfo = document.getElementById('locationInfo');
        const locationText = document.getElementById('locationText');
        
        let stream = null;
        let isStreaming = false;
        let sendInterval = null;
        let uploading = false;
        let targetInterval = 200;
        let frameTimeout = null;
        let userLocation = null;

        toggleBtn.addEventListener('click', async () => {
            if (!isStreaming) {
                await startCamera();
            } else {
                stopCamera();
            }
        });

        async function startCamera() {
            try {
                // Detectar iOS/Safari para ajustar constraints
                const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 360 },
                        frameRate: isiOS ? { ideal: 12, max: 15 } : { ideal: 15, max: 20 },
                        facingMode: 'user'
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Atributos cr칤ticos para iOS Safari
                video.setAttribute('playsinline', 'true');
                video.setAttribute('autoplay', 'true');
                video.setAttribute('muted', 'true');
                video.muted = true;
                video.autoplay = true;
                
                video.style.display = 'block';
                isStreaming = true;
                toggleBtn.textContent = '{% trans "Desactivar C치mara" %}';
                toggleBtn.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                statusDiv.textContent = '{% trans "C치mara activa - Transmitiendo..." %}';
                statusDiv.style.color = 'var(--accent-green)';
                fatigueScoreDiv.style.display = 'block';
                
                // Obtener ubicaci칩n GPS
                getLocation();

                // Esperar a que el video est칠 listo
                video.onloadedmetadata = () => {
                    // Normalizar resoluci칩n para reducir ancho de banda
                    const targetW = 640;
                    const aspect = video.videoHeight / video.videoWidth || (9/16);
                    const targetH = Math.round(targetW * aspect);
                    canvas.width = targetW;
                    canvas.height = targetH;
                    ctx.imageSmoothingEnabled = true;
                    
                    // Scheduler adaptativo para iOS (evita solapamiento)
                    targetInterval = isiOS ? 250 : 200;
                    scheduleNext();
                };

            } catch (error) {
                console.error('Error al acceder a la c치mara:', error);
                statusDiv.textContent = 'Error: No se pudo acceder a la c치mara';
                statusDiv.style.color = '#e74c3c';
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
                stream = null;
            }
            
            if (sendInterval) {
                clearInterval(sendInterval);
                sendInterval = null;
            }
            if (frameTimeout) {
                clearTimeout(frameTimeout);
                frameTimeout = null;
            }
            
            isStreaming = false;
            uploading = false;
            toggleBtn.textContent = '{% trans "Activar C치mara" %}';
            toggleBtn.style.background = 'linear-gradient(90deg, var(--accent-green), var(--accent-magenta))';
            statusDiv.textContent = '{% trans "C치mara desactivada" %}';
            statusDiv.style.color = 'var(--muted)';
            fatigueScoreDiv.style.display = 'none';
            locationInfo.style.display = 'none';
            userLocation = null;

            // Notificar al servidor que se detuvo la transmisi칩n
            fetch('/conductor/stop_stream/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
        }

        function scheduleNext() {
            if (frameTimeout) clearTimeout(frameTimeout);
            frameTimeout = setTimeout(sendFrame, targetInterval);
        }

        async function sendFrame() {
            // Back-pressure: no enviar si el anterior no termin칩
            if (!isStreaming || video.paused || video.ended || uploading) {
                if (isStreaming) scheduleNext();
                return;
            }
            
            uploading = true;
            const t0 = performance.now();
            
            // Dibujar frame reescalado al canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Ajustar calidad JPEG seg칰n plataforma
            const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const quality = isiOS ? 0.5 : 0.6;
            
            canvas.toBlob(async (blob) => {
                try {
                    if (!blob) {
                        uploading = false;
                        scheduleNext();
                        return;
                    }

                    const formData = new FormData();
                    formData.append('frame', blob, 'frame.jpg');
                    
                    const response = await fetch('/conductor/send_frame/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData,
                        cache: 'no-store'
                    });

                    const data = await response.json();
                    if (data && typeof data.score === 'number') {
                        scoreValue.textContent = data.score;
                        
                        // Cambiar color seg칰n el nivel de fatiga
                        if (data.score < 30) {
                            scoreValue.style.color = 'var(--accent-green)';
                        } else if (data.score < 70) {
                            scoreValue.style.color = '#ff9f43';
                        } else {
                            scoreValue.style.color = '#e74c3c';
                        }

                        // Mostrar alerta visual si score < 50
                        if (data.score < 50) {
                            fatigueRiskAlert.style.display = 'block';
                        } else {
                            fatigueRiskAlert.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error al enviar frame:', error);
                } finally {
                    const dt = performance.now() - t0;
                    // Adaptar intervalo din치micamente seg칰n latencia de red
                    const adaptiveInterval = Math.min(500, Math.max(150, Math.round(dt * 1.3)));
                    targetInterval = adaptiveInterval;
                    uploading = false;
                    scheduleNext();
                }
            }, 'image/jpeg', quality);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getLocation() {
            locationInfo.style.display = 'block';
            
            if (!navigator.geolocation) {
                locationText.textContent = 'Geolocalizaci칩n no disponible en este navegador';
                locationText.style.color = '#ff9f43';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    userLocation = { lat, lon };
                    
                    // Mostrar coordenadas inmediatamente
                    locationText.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    locationText.style.color = 'var(--accent-green)';
                    
                    // Intentar obtener direcci칩n legible usando Nominatim (OpenStreetMap)
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`,
                            {
                                headers: {
                                    'User-Agent': 'EyeGuard/1.0'
                                }
                            }
                        );
                        const data = await response.json();
                        
                        if (data && data.display_name) {
                            // Mostrar direcci칩n legible
                            const address = data.address;
                            let shortAddress = '';
                            
                            if (address.road) shortAddress += address.road;
                            if (address.city) shortAddress += (shortAddress ? ', ' : '') + address.city;
                            else if (address.town) shortAddress += (shortAddress ? ', ' : '') + address.town;
                            else if (address.municipality) shortAddress += (shortAddress ? ', ' : '') + address.municipality;
                            if (address.state) shortAddress += (shortAddress ? ', ' : '') + address.state;
                            
                            locationText.textContent = shortAddress || data.display_name.substring(0, 50);
                            locationText.title = `Coordenadas: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                        }
                    } catch (error) {
                        console.log('No se pudo obtener direcci칩n, mostrando coordenadas');
                        // Las coordenadas ya est치n mostradas
                    }
                },
                (error) => {
                    console.error('Error al obtener ubicaci칩n:', error);
                    let errorMsg = 'No se pudo obtener ubicaci칩n';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Permiso de ubicaci칩n denegado';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Ubicaci칩n no disponible';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Tiempo de espera agotado';
                            break;
                    }
                    
                    locationText.textContent = errorMsg;
                    locationText.style.color = '#ff9f43';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Detener la c치mara cuando se cierre la p치gina
        window.addEventListener('beforeunload', () => {
            if (isStreaming) {
                stopCamera();
            }
        });

        // Language selector logic
        document.addEventListener('DOMContentLoaded', function() {
            const currentLang = getCookie('django_language') || 'es';
            document.querySelectorAll('.language-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById('lang-' + currentLang);
            if (activeBtn) activeBtn.classList.add('active');
        });

        function changeLanguage(langCode) {
            document.cookie = 'django_language=' + langCode + '; path=/; max-age=31536000';
            window.location.reload();
        }
    </script>
</body>
</html>
